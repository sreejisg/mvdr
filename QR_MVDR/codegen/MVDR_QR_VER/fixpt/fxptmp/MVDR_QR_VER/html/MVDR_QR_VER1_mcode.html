<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> MVDR_QR_VER(<span class="var type1" id="S2T1U5">rcvdata</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">%make</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%clear all</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">%LoadData</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">%clc</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">%close all</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="keyword">global</span> <span class="var type0" id="S3T0U7">power_db</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">%% DEFINE ARRAY</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="var type1" id="S4T1U10">f0</span> = 2.976e6; <span class="comment">% Central frequency [Hz]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="var type1" id="S5T1U14">fs</span> = 4*<span class="var type1" id="S4T1U17">f0</span>; <span class="comment">% Sampling frequency [Hz]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="var type1" id="S6T1U20">c</span> = 1540; <span class="comment">% Speed of sound [m/s]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="var type1" id="S7T1U24">N</span> = 64;<span class="comment">% Number of elements in the transducer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="var type1" id="S8T1U28">L</span>=8;<span class="comment">% subarray size</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="var type0" id="S9T0U32">Ts</span> = 1/<span class="var type1" id="S5T1U35">fs</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="var type0" id="S10T0U38">lambda</span> = <span class="var type1" id="S6T1U40">c</span> / <span class="var type1" id="S4T1U41">f0</span>; <span class="comment">% Wavelength [m]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">% width = (0.4831/1000)*lambda;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% kerf = (0.2895/1000)*lambda; % Inter-element spacing [m]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% pitch = width+kerf;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line">  <span class="var type1" id="S11T1U44">pitch</span> = 0.299/1000;<span class="comment">% Pitch - center-to-center [m]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">% pitch = 0.1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">% pitch = 0.30/1000;% Pitch - center-to-center [m]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">% kerf = 0.025/1000;% Inter-element spacing [m]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">% width = pitch - kerf;% Width of the element [m]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">% height = 13/1000; % Size in the Y direction [m]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="var type1" id="S12T1U50">Nd</span>=(<span class="var type1" id="S7T1U54">N</span>-1)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="var type1" id="S13T1U59">d</span>=<span class="var type1" id="S11T1U60">pitch</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">% checkGaussDist = 1; </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"> <span class="comment">% Define and create the image</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"> <span class="var type1" id="S14T1U63">sector</span> = 60 * pi / 180;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"> <span class="var type1" id="S16T1U72">no_lines</span> = 61;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"> <span class="var type1" id="S17T1U76">d_theta</span> = <span class="var type1" id="S14T1U78">sector</span> / (<span class="var type1" id="S16T1U81">no_lines</span>-1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"> <span class="comment">%theta=-1* pi / 180;;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"> <span class="var type1" id="S18T1U85">theta</span> = (-<span class="var type1" id="S14T1U89">sector</span>/2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">%  theta = -(no_lines-1) / 2 * d_theta;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="comment">%  times = zeros(1, 61); </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">%  theta_emit = -sector/2;                 % Start angle for transmit aperture</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">%  theta_receive = theta_emit;             % Start angle for receive aperture</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="comment">%  theta_start = theta_emit; </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"><span class="comment">%  Rmax = max(sqrt(pht_pos(:,1).^2  + pht_pos(:,2).^ 2 + pht_pos(:,3).^ 2)) + 15/1000;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">% Rmax=82.8/1000;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"> <span class="var type0" id="S19T0U93">Rmax</span>=120/1000;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"> <span class="var type1" id="S20T1U99">no_rf_samples</span> = 1536;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"> <span class="var type0" id="S21T0U103">rf_line</span> = zeros(<span class="var type1" id="S20T1U106">no_rf_samples</span>, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"> <span class="var type0" id="S23T0U110">conv_line</span>=zeros(<span class="mxinfo " id="T1:U25">2048</span>,1);<span class="comment">%zeros(2^nextpow2(no_rf_samples), 1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="comment">%  env_line = zeros(no_rf_samples, no_lines);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"> <span class="var type0" id="S24T0U117">conv_temp2</span>  = zeros(<span class="mxinfo " id="T1:U26">2^nextpow2(<span class="var type1" id="S20T1U124">no_rf_samples</span>)</span>, <span class="var type1" id="S16T1U125">no_lines</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">%  xmt_r = (max(focus_r) + min(focus_r) )/2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="comment">%  FRx=focus_r;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"> <span class="var type1" id="S26T1U128">FTx</span>=60/1000;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"> <span class="var type0" id="S27T0U135"><span class="message error" id="M1F1C">CBFY</span></span>(<span class="var type0" id="S16T0U136">no_lines</span>,2^nextpow2(<span class="var type0" id="S20T0U141">no_rf_samples</span>))=0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"> <span class="var type1" id="S28T1U145">sln</span>=61</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"> <span class="var type1" id="S29T2U149">MVDRY</span>=zeros(<span class="mxinfo " id="T1:U32">1</span>,<span class="mxinfo " id="T1:U33">2048</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"> <span class="keyword">for</span> <span class="var type1" id="S30T1U156">i</span> =1 :<span class="var type1" id="S16T1U159">no_lines</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">   <span class="var type0" id="S21T0U163">rf_line</span>(:) = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">   disp([<span class="string">'Line_no'</span> <span class="message error" id="M2F1C">num2str(<span class="var type1" id="S30T1U174">i</span>)</span>]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"> <span class="comment">% Beamform with Field II</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="comment">%    rf_data=rcvdata(1+((scan-1)*(768*2)):scan*(768*2),:);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line">     <span class="var type1" id="S33T3U177">rf_data</span>=<span class="var type1" id="S2T1U179">rcvdata</span>(1+(((62-<span class="var type1" id="S30T1U190">i</span>)-1)*(1536*1)):(62-<span class="var type1" id="S30T1U200">i</span>)*(1536*1),:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="comment">%    rf_data = rcvdata(:,:,sln,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line">   <span class="var type1" id="S28T1U208">sln</span> = <span class="var type1" id="S28T1U210">sln</span> -1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">   <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line">   <span class="comment">% MVDR and Freq Domain BF Beamforming</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">   <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">   <span class="comment">%%%%%%%%%%%%%%% Array Signal Generation %%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">  <span class="var type1" id="S34T1U214">M</span>=length(<span class="var type1" id="S33T3U217">rf_data</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">   <span class="var type1" id="S36T1U220">Nfft</span> = 2^nextpow2(<span class="var type1" id="S20T1U225">no_rf_samples</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">   <span class="var type1" id="S37T1U228">Nbin</span> = <span class="var type1" id="S36T1U229">Nfft</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">   <span class="var type1" id="S38T4U232">rf_datatr</span>=<span class="var type1" id="S33T3U234">rf_data</span>';</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">   <span class="var type1" id="S39T5U237">rf_data_fft</span>=fft(<span class="var type1" id="S38T4U242">rf_datatr</span>.',<span class="var type1" id="S36T1U243">Nfft</span>).';</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"><span class="comment">%   %%%%%%%%%%%%%%%%% Overlapped FFT %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="comment">%   OL_SKIP = 896; %%% 12.5 % overlap</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">%   OL_BLOCK = floor(M/OL_SKIP);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="comment">%    for q=0:OL_BLOCK-1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"><span class="comment">%      p=rf_data(((OL_SKIP*q)+1):(Nfft+(OL_SKIP*q)),1:N);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="comment">%      rf_data_fft=fft(p,Nfft).';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">   <span class="comment">%%%%%%%%%%%%%%%%%% Delay Calculation %%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">     <span class="var type1" id="S41T1U246">y1</span>=sqrt(1+((<span class="var type1" id="S12T1U257">Nd</span>*<span class="var type1" id="S13T1U258">d</span>)/<span class="var type1" id="S26T1U259">FTx</span>)^2+((2*<span class="var type1" id="S12T1U268">Nd</span>*<span class="var type1" id="S13T1U269">d</span>)/<span class="var type1" id="S26T1U270">FTx</span>)*sin(<span class="var type1" id="S18T1U273">theta</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">     <span class="var type1" id="S44T6U276">y2</span>=sqrt((1+((((0:1:<span class="var type1" id="S7T1U296">N</span>-1)-<span class="var type1" id="S12T1U298">Nd</span>)*<span class="var type1" id="S13T1U299">d</span>)/<span class="var type1" id="S26T1U300">FTx</span>).^2-(((2*((0:1:<span class="var type1" id="S7T1U318">N</span>-1)-<span class="var type1" id="S12T1U320">Nd</span>)*<span class="var type1" id="S13T1U321">d</span>)/<span class="var type1" id="S26T1U322">FTx</span>)*sin(<span class="var type1" id="S18T1U325">theta</span>))));</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">     <span class="var type1" id="S45T6U328">tauTxFocus</span> =((<span class="var type1" id="S26T1U334">FTx</span>/<span class="var type1" id="S6T1U335">c</span>)*(<span class="var type1" id="S41T1U338">y1</span>-<span class="var type1" id="S44T6U339">y2</span>)*<span class="var type1" id="S5T1U340">fs</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="comment">%      for i0=1:N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="comment">%         angle=theta;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"><span class="comment">%         F=FTx;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line"><span class="comment">%         aa=(Nd*d/F)^2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"><span class="comment">%         bb=2*Nd*d*sin(angle)/F;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">%         cc=((i0-1-Nd)*d/F)^2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="comment">%         dd=2*(i0-1-Nd)*d*sin(angle)/F;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="comment">%         tt=(F/c)*((sqrt(1+aa+bb))-(sqrt(1+cc-dd)));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"><span class="comment">%         time(i0)=tt*fs;   %time delays</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"><span class="comment">% end   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="comment">%     for k=1:1:N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="comment">%      if(tauTxFocus(k)&lt;0)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line"><span class="comment">%        tauTxFocus(k)=tauTxFocus(k)+max(abs(tauTxFocus));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="comment">%      end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"><span class="comment">%    end  </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">%      </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">     <span class="keyword">if</span> <span class="var type1" id="S45T6U344">tauTxFocus</span>&gt;0</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">       <span class="var type1" id="S45T6U348">tauTxFocus</span>=<span class="var type1" id="S45T6U349">tauTxFocus</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">     <span class="keyword">else</span>   </span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">       <span class="var type1" id="S45T6U353">tauTxFocus</span>=<span class="var type1" id="S45T6U355">tauTxFocus</span> + abs(min(<span class="var type1" id="S45T6U360">tauTxFocus</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">      <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="comment">%    rf_data_fft1=zeros(64,2048);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"><span class="comment">%    delay=fix(tauTxFocus)+ones(1,64);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"><span class="comment">%    for g=1:1:64</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"><span class="comment">%       rf_data_fft1(g,delay(g):2048)=rf_data_fft(g,1:(2048-delay(g)+1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"><span class="comment">%    end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">  <span class="keyword">for</span> <span class="var type1" id="S48T1U363">ibin</span>=1:<span class="var type1" id="S37T1U366">Nbin</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"><span class="comment">%       ibin=Nbin-ibin+1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">      <span class="var type0" id="S49T0U370"><span class="message error" id="M3F1C">StVect</span></span>(:,<span class="var type0" id="S48T0U372">ibin</span>)=exp(j*2e-04*pi*(1/<span class="var type1" id="S36T1U388">Nfft</span>)*<span class="var type1" id="S48T1U389">ibin</span>*<span class="var type1" id="S45T6U390">tauTxFocus</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">   <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line"><span class="comment">%      pow_bin=0;  </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">     <span class="keyword">for</span> <span class="var type1" id="S52T1U393">k</span>=1:<span class="var type1" id="S37T1U396">Nbin</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"><span class="comment">% %        mmm=Nbin-k+1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">       <span class="var type0" id="S53T0U399">X</span>= <span class="var type1" id="S39T5U402">rf_data_fft</span>(:,<span class="var type1" id="S52T1U404">k</span>).* <span class="var type0" id="S49T0U406"><span class="message error" id="M4F1C">StVect</span></span>(:,<span class="var type0" id="S52T0U408">k</span>); <span class="comment">% Delay compensated Frequency domain data.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">       <span class="var type1" id="S54T7U411">U</span>=zeros(<span class="mxinfo " id="T1:U94"><span class="var type1" id="S7T1U416">N</span>-<span class="var type1" id="S8T1U417">L</span>+1</span>,<span class="mxinfo " id="T1:U97">8</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">       <span class="comment">%R=zeros(8,8);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">       <span class="comment">%D=zeros(8,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">       <span class="keyword">for</span> <span class="var type1" id="S55T1U422">l</span>=0:1:<span class="var type1" id="S7T1U428">N</span>-<span class="var type1" id="S8T1U429">L</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">           <span class="var type0" id="S56T0U432">s</span>=<span class="var type1" id="S55T1U434">l</span>+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">             <span class="var type0" id="S54T0U439">U</span>(<span class="var type0" id="S56T0U440">s</span>,:)=<span class="var type0" id="S53T0U443"><span class="message error" id="M5F1C">X</span></span>(<span class="var type0" id="S7T0U447">N</span>-<span class="var type0" id="S55T0U448">l</span>-7:<span class="var type0" id="S7T0U451">N</span>-<span class="var type0" id="S55T0U452">l</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line"><span class="comment">%              U(s,:)=X(s:s+7);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">             <span class="comment">%D=D+X(l:l+7);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">             <span class="comment">%R= R + D*D';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">       <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">       [<span class="var type1" id="S57T7U456">Q</span>,<span class="var type1" id="S58T8U457">S</span>,<span class="var type1" id="S59T9U458">E</span>] = qr(<span class="var type1" id="S54T7U461">U</span>,0);</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">       <span class="comment">%R=1/(N-L+1)*R;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">       <span class="comment">%D=1/(N-L+1)*D;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">       <span class="var type1" id="S61T10U465">sv1</span>=[1;1;1;1;1;1;1;1];</span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line"><span class="comment">%         sv=zeros(64,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line"><span class="comment">%         sv=StVect(:,i);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">       <span class="var type1" id="S62T8U485">S_tran</span>=<span class="var type1" id="S58T8U487">S</span>';</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">       <span class="var type1" id="S63T1U490">nn</span>=8;</span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">       <span class="comment">%sv1_z=forwardSubstitution(S_tran,sv1,nn); </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">       <span class="var type1" id="S64T10U494">sv1_z</span>=zeros(<span class="var type1" id="S63T1U497">nn</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">  <span class="keyword">for</span> <span class="var type1" id="S65T1U501">kk</span>=1:<span class="var type1" id="S63T1U504">nn</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">    <span class="keyword">if</span> (<span class="var type1" id="S62T8U510">S_tran</span>(<span class="var type1" id="S65T1U511">kk</span>,<span class="var type1" id="S65T1U512">kk</span>)==0) error(<span class="string">'Matrix is singular!'</span>); <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">    <span class="var type1" id="S64T10U521">sv1_z</span>(<span class="var type1" id="S65T1U522">kk</span>)=<span class="var type1" id="S61T10U525">sv1</span>(<span class="var type1" id="S65T1U526">kk</span>)/<span class="var type1" id="S62T8U528">S_tran</span>(<span class="var type1" id="S65T1U529">kk</span>,<span class="var type1" id="S65T1U530">kk</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">    <span class="var type1" id="S61T10U534">sv1</span>(<span class="var type1" id="S65T1U537">kk</span>+1:<span class="var type1" id="S63T1U539">nn</span>)=<span class="var type1" id="S61T10U542">sv1</span>(<span class="var type1" id="S65T1U545">kk</span>+1:<span class="var type1" id="S63T1U547">nn</span>)-<span class="var type1" id="S62T8U550">S_tran</span>(<span class="var type1" id="S65T1U553">kk</span>+1:<span class="var type1" id="S63T1U555">nn</span>,<span class="var type1" id="S65T1U556">kk</span>)*<span class="var type1" id="S64T10U558">sv1_z</span>(<span class="var type1" id="S65T1U559">kk</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">  <span class="keyword">end</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">       <span class="comment">%R= (R+eye(L,L));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">       <span class="comment">%RiE= (R\sv1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">       <span class="var type1" id="S67T10U562">W</span>=<span class="var type1" id="S64T10U564">sv1_z</span>/(<span class="var type1" id="S64T10U568">sv1_z</span>'*<span class="var type1" id="S64T10U569">sv1_z</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">       <span class="comment">%pow_bin = pow_bin +  1/(sv1'*RiE);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">       <span class="var type0" id="S68T0U572">x_mean</span>= zeros(<span class="var type1" id="S8T1U575">L</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">       <span class="var type1" id="S68T10U579">x_mean</span>=1/(<span class="var type1" id="S7T1U586">N</span>-<span class="var type1" id="S8T1U587">L</span>+1)*sum(<span class="var type1" id="S54T7U592">U</span>',2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">       <span class="var type1" id="S61T10U596">sv1</span>=<span class="var type1" id="S68T10U597">x_mean</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">       <span class="comment">%Zmean=forwardSubstitution(S_tran,sv1,nn); </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">       <span class="var type1" id="S70T10U600">Zmean</span>=zeros(<span class="var type1" id="S63T1U603">nn</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S65T1U607">kk</span>=1:<span class="var type1" id="S63T1U610">nn</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">            <span class="keyword">if</span> (<span class="var type1" id="S62T8U616">S_tran</span>(<span class="var type1" id="S65T1U617">kk</span>,<span class="var type1" id="S65T1U618">kk</span>)==0) error(<span class="string">'Matrix is singular!'</span>); <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">             <span class="var type1" id="S70T10U627">Zmean</span>(<span class="var type1" id="S65T1U628">kk</span>)=<span class="var type1" id="S61T10U631">sv1</span>(<span class="var type1" id="S65T1U632">kk</span>)/<span class="var type1" id="S62T8U634">S_tran</span>(<span class="var type1" id="S65T1U635">kk</span>,<span class="var type1" id="S65T1U636">kk</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line">            <span class="var type1" id="S61T10U640">sv1</span>(<span class="var type1" id="S65T1U643">kk</span>+1:<span class="var type1" id="S63T1U645">nn</span>)=<span class="var type1" id="S61T10U648">sv1</span>(<span class="var type1" id="S65T1U651">kk</span>+1:<span class="var type1" id="S63T1U653">nn</span>)-<span class="var type1" id="S62T8U656">S_tran</span>(<span class="var type1" id="S65T1U659">kk</span>+1:<span class="var type1" id="S63T1U661">nn</span>,<span class="var type1" id="S65T1U662">kk</span>)*<span class="var type1" id="S70T10U664">Zmean</span>(<span class="var type1" id="S65T1U665">kk</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line">        <span class="keyword">end</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">       <span class="var type1" id="S29T2U669">MVDRY</span>(<span class="var type1" id="S52T1U670">k</span>) = <span class="var type1" id="S67T10U673">W</span>'*<span class="var type1" id="S70T10U674">Zmean</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">     <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line"><span class="comment">%        power_tot_bin(i) = abs(pow_bin); </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line"><span class="comment">%     </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line"><span class="comment">%      power_instantaneous(i)=MVDRY(i,:)*MVDRY(i,:)';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line"><span class="comment">%      </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">     <span class="comment">%Power(i)=alpha*Power(i)+(1-alpha)*power_instantaneous(i);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">   <span class="comment">%del = exp(-j*2*pi*(fs/M)*tau*t);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line"> <span class="comment">%%%%%%%%%%%%%%%%%%% Delay Estinmatioin %%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">   <span class="var type1" id="S55T1U677">l</span>=1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">   <span class="keyword">for</span> <span class="var type1" id="S71T1U681">j1</span>=1:1:<span class="var type1" id="S7T1U686">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">       <span class="keyword">for</span> <span class="var type1" id="S52T1U689">k</span>=1:1:<span class="var type1" id="S34T1U694">M</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">           <span class="keyword">if</span>(<span class="var type1" id="S33T3U700">rf_data</span>(<span class="var type1" id="S52T1U701">k</span>,<span class="var type1" id="S71T1U702">j1</span>)~=0)</span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">               <span class="var type0" id="S72T0U707"><span class="message error" id="M6F1C">count_indx</span></span>(<span class="var type0" id="S55T0U708">l</span>)=<span class="var type1" id="S52T1U709">k</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">               <span class="var type1" id="S55T1U712">l</span>=<span class="var type1" id="S55T1U714">l</span>+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">               <span class="keyword">break</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line">           <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">   <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line">    <span class="var type0" id="S73T0U719">est_delay</span> = max(<span class="var type0" id="S72T0U723"><span class="message error" id="M7F1C">count_indx</span></span>)-<span class="var type0" id="S72T0U724">count_indx</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line"><span class="comment">%     stem(est_delay);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line"><span class="comment">%     hold on</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line"><span class="comment">%     stem(tauTxFocus,'r');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"><span class="comment">%     delay_err=abs(est_delay-tauTxFocus);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line"><span class="comment">%     delay_tot(i)=sum(delay_err');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%% Bin Processing %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line"><span class="comment">%     for ibin=1:Nbin</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line"><span class="comment">%             s=StVect(:,ibin)';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line"><span class="comment">%             s_conj = conj(s);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line"><span class="comment">%             X= rf_data_fft(:,ibin);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line"><span class="comment">% %             R=X*X';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line"><span class="comment">% %             RinvS= (R+eye(N,N))\s';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line"><span class="comment">% %             W=RinvS/(s*RinvS);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line"><span class="comment">% %             MVDRY(ibin,i) = W'*X;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line"><span class="comment">%             CBFY(ibin,i)=s * rf_data_fft(:,ibin); %Conv BF</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line"><span class="comment">%     </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line"><span class="comment">%    temp_power_cbf=0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line"><span class="comment">%         temp_power_mvdr=0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line"><span class="comment">%             for ibin = 1 : Nbin/2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line"><span class="comment">%                 temp_power_cbf=temp_power_cbf+CBFY(i,ibin)*conj(CBFY(i,ibin));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line"><span class="comment">%                 %temp_power_mvdr = temp_power_mvdr + MVDRY(ibin-1,ntheta)*conj(MVDRY(ibin-1,ntheta));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line"><span class="comment">%             end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line"><span class="comment">%         powercbf(i)=temp_power_cbf;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line"><span class="comment">%        % powermvdr(i) = temp_power_mvdr;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line"><span class="comment">%    %conv_temp=sum(conv_bf_data');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line"><span class="comment">%    %conv_temp = sum(conv_bf_data_fract);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line"><span class="comment">%    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line"><span class="comment">%    start_t = start_t+2/ fs;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line"><span class="comment">%   % conv_temp = conv_beamform(start t, rf_data);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line"><span class="comment">%    start_sample = t(i)*fs; no_temp_samples = length(rf_temp);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line"><span class="comment">%    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line"><span class="comment">%    rf_line(start_sample:start_sample+no_temp_samples-1) = rf_temp(1:no_temp_samples);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line"><span class="comment">%    env_line(:,i) = abs(hilbert(rf_line(:)));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line"><span class="comment">%     start_sample = floor(start_t*fs); </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line">    <span class="var type0" id="S75T0U728"><span class="message error" id="M8F1C">conv_temp1</span></span>(:,<span class="var type0" id="S30T0U730">i</span>) = real(ifft(<span class="var type1" id="S29T2U735">MVDRY</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line"><span class="comment">%     conv_temp1=flipud(conv_temp1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line"><span class="comment">%     mvdr_time_domain(((OL_SKIP*q)+1):(Nfft+(OL_SKIP*q)))=conv_temp1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,246" id="srcline246">246</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,247" id="srcline247">247</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,248" id="srcline248">248</a></span><span class="line"><span class="comment">%    end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,249" id="srcline249">249</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,250" id="srcline250">250</a></span><span class="line"><span class="comment">%     conv_temp =mvdr_time_domain;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,251" id="srcline251">251</a></span><span class="line"><span class="comment">%    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,252" id="srcline252">252</a></span><span class="line"><span class="comment">%     no_temp_samples = length(mvdr_time_domain);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,253" id="srcline253">253</a></span><span class="line"><span class="comment">%     conv_line = mvdr_time_domain;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,254" id="srcline254">254</a></span><span class="line"><span class="comment">%    env_bf(:,i) = abs(hilbert(conv_temp1 ));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,255" id="srcline255">255</a></span><span class="line">   <span class="var type1" id="S18T1U738">theta</span> = <span class="var type1" id="S18T1U740">theta</span> + <span class="var type1" id="S17T1U741">d_theta</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,256" id="srcline256">256</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,257" id="srcline257">257</a></span><span class="line"> <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,258" id="srcline258">258</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,259" id="srcline259">259</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,260" id="srcline260">260</a></span><span class="line"><span class="comment">%% GENERATE IMAGE FROM RF-DATA </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,261" id="srcline261">261</a></span><span class="line"><span class="var type1" id="S78T1U744">D</span> = 1;              <span class="comment">% Decimation factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,262" id="srcline262">262</a></span><span class="line"><span class="comment">% dyn = 40;           % Dynamic range</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,263" id="srcline263">263</a></span><span class="line"><span class="comment">% gain = 0; </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,264" id="srcline264">264</a></span><span class="line"><span class="var type1" id="S79T1U748">dyn</span> = 17;           <span class="comment">% Dynamic range</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,265" id="srcline265">265</a></span><span class="line"><span class="var type1" id="S80T1U752">gain</span> = 15;           <span class="comment">% Image gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,266" id="srcline266">266</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,267" id="srcline267">267</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,268" id="srcline268">268</a></span><span class="line"><span class="comment">%% Decimate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,269" id="srcline269">269</a></span><span class="line"><span class="var type0" id="S81T0U756">rf_d</span> =flipud(<span class="var type0" id="S75T0U759"><span class="message error" id="M9F1C">conv_temp1</span></span>);<span class="comment">%(1:D:size(conv_temp1, 1), :);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,270" id="srcline270">270</a></span><span class="line"><span class="var type0" id="S81T0U762">rf_d</span> = <span class="var type0" id="S81T0U764"><span class="message error" id="M10F1C">rf_d</span></span>(1:1536,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,271" id="srcline271">271</a></span><span class="line"><span class="var type0" id="S83T0U771">fn</span>= <span class="var type1" id="S5T1U773">fs</span>/<span class="var type1" id="S78T1U774">D</span>;           <span class="comment">% New sampling frequency</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,272" id="srcline272">272</a></span><span class="line"><span class="var type1" id="S84T11U777">power11</span>=zeros(<span class="mxinfo " id="T1:U198">1</span>,<span class="mxinfo " id="T1:U199">61</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,273" id="srcline273">273</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S63T1U784">nn</span>=1:61</span></span>
<span class="srcline"><span class="lineno"><a href="1,274" id="srcline274">274</a></span><span class="line">    <span class="var type0" id="S85T0U790">ppp</span>=<span class="var type0" id="S81T0U792"><span class="message error" id="M11F1C">rf_d</span></span>(:,<span class="var type0" id="S63T0U794">nn</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,275" id="srcline275">275</a></span><span class="line">    <span class="var type0" id="S86T0U797">power</span>=<span class="var type0" id="S85T0U800"><span class="message error" id="M12F1C">ppp</span></span>'*<span class="var type0" id="S85T0U801">ppp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,276" id="srcline276">276</a></span><span class="line">    <span class="var type0" id="S84T0U805">power11</span>(<span class="var type0" id="S63T0U806">nn</span>)=<span class="var type0" id="S86T0U807"><span class="message error" id="M13F1C">power</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,277" id="srcline277">277</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,278" id="srcline278">278</a></span><span class="line"><span class="var type1" id="S87T11U810">power22</span>=<span class="var type1" id="S84T11U812">power11</span>/max(<span class="var type1" id="S84T11U815">power11</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,279" id="srcline279">279</a></span><span class="line"><span class="var type1" id="S3T11U818">power_db</span>=10*log10(<span class="var type1" id="S87T11U823">power22</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,280" id="srcline280">280</a></span><span class="line"><span class="autoExtrinsicFcn" id="F479N8:B826">figure</span> (7);</span></span>
<span class="srcline"><span class="lineno"><a href="1,281" id="srcline281">281</a></span><span class="line"><span class="autoExtrinsicFcn" id="F480N11:B830">plot</span>(<span class="var type1" id="S3T11U831">power_db</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,282" id="srcline282">282</a></span><span class="line"><span class="extrinsicFcn" id="F483N12:B834">set</span>(<span class="autoExtrinsicFcn" id="F481N9:B836">gca</span>,<span class="string">'XTick'</span>,0:10:60)</span></span>
<span class="srcline"><span class="lineno"><a href="1,283" id="srcline283">283</a></span><span class="line"><span class="extrinsicFcn" id="F486N12:B845">set</span>(<span class="autoExtrinsicFcn" id="F484N9:B847">gca</span>,<span class="string">'XTickLabel'</span>,-30:10:30)</span></span>
<span class="srcline"><span class="lineno"><a href="1,284" id="srcline284">284</a></span><span class="line"><span class="autoExtrinsicFcn" id="F487N13:B857">xlabel</span>(<span class="string">'Beam angle [deg]'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,285" id="srcline285">285</a></span><span class="line"><span class="autoExtrinsicFcn" id="F488N14:B861">ylabel</span>(<span class="string">'power in dB'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,286" id="srcline286">286</a></span><span class="line"><span class="autoExtrinsicFcn" id="F489N8:B865">figure</span> (8);</span></span>
<span class="srcline"><span class="lineno"><a href="1,287" id="srcline287">287</a></span><span class="line"><span class="autoExtrinsicFcn" id="F490N11:B869">plot</span>(<span class="var type1" id="S3T11U870">power_db</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,288" id="srcline288">288</a></span><span class="line"><span class="extrinsicFcn" id="F492N12:B873">set</span>(<span class="autoExtrinsicFcn" id="F491N9:B875">gca</span>,<span class="string">'XTick'</span>,0:10:60)</span></span>
<span class="srcline"><span class="lineno"><a href="1,289" id="srcline289">289</a></span><span class="line"><span class="extrinsicFcn" id="F498N12:B884">set</span>(<span class="autoExtrinsicFcn" id="F493N9:B886">gca</span>,<span class="string">'XTickLabel'</span>,-20:6.6:19.6)</span></span>
<span class="srcline"><span class="lineno"><a href="1,290" id="srcline290">290</a></span><span class="line"><span class="autoExtrinsicFcn" id="F499N13:B896">xlabel</span>(<span class="string">'Lateral distance [mm]'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,291" id="srcline291">291</a></span><span class="line"><span class="autoExtrinsicFcn" id="F500N14:B900">ylabel</span>(<span class="string">'power in dB'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,292" id="srcline292">292</a></span><span class="line"><span class="comment">% % Check distribution</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,293" id="srcline293">293</a></span><span class="line"><span class="comment">% if checkGaussDist==0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,294" id="srcline294">294</a></span><span class="line"><span class="comment">%     figure</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,295" id="srcline295">295</a></span><span class="line"><span class="comment">%     imagesc(rf_d);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,296" id="srcline296">296</a></span><span class="line"><span class="comment">%     [x, y] = ginput(2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,297" id="srcline297">297</a></span><span class="line"><span class="comment">%     hold on</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,298" id="srcline298">298</a></span><span class="line"><span class="comment">%     plot([x(1), x(1), x(2), x(2), x(1)], [y(1), y(2), y(2), y(1), y(1)], 'r')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,299" id="srcline299">299</a></span><span class="line"><span class="comment">%     hold off</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,300" id="srcline300">300</a></span><span class="line"><span class="comment">%     histData = rf_d(y(1):y(2), x(1):x(2));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,301" id="srcline301">301</a></span><span class="line"><span class="comment">%     figure;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,302" id="srcline302">302</a></span><span class="line"><span class="comment">%     histfit(histData(:), 100);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,303" id="srcline303">303</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,304" id="srcline304">304</a></span><span class="line"><span class="comment">% % % % %     figure(1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,305" id="srcline305">305</a></span><span class="line"><span class="comment">% % % % %     plot(rf_d);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,306" id="srcline306">306</a></span><span class="line"><span class="comment">%     x11=rf_d*2^70;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,307" id="srcline307">307</a></span><span class="line"><span class="comment">%     x1=int16(x11);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,308" id="srcline308">308</a></span><span class="line"><span class="comment">%    figure(7);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,309" id="srcline309">309</a></span><span class="line"><span class="comment">%    plot(x1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,310" id="srcline310">310</a></span><span class="line"><span class="comment">%% Hilbert transform data</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,311" id="srcline311">311</a></span><span class="line"><span class="var type0" id="S95T0U904">rf_h</span> = hilbert(<span class="var type0" id="S81T0U907"><span class="message error" id="M14F1C">rf_d</span></span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,312" id="srcline312">312</a></span><span class="line"><span class="comment">% figure(2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,313" id="srcline313">313</a></span><span class="line"><span class="comment">% plot (abs(rf_h));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,314" id="srcline314">314</a></span><span class="line"><span class="comment">%% IQ demodulate data</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,315" id="srcline315">315</a></span><span class="line"><span class="var type0" id="S97T0U910">t_dmod</span> = (0:size(<span class="var type0" id="S95T0U919"><span class="message error" id="M15F1C">rf_h</span></span>,1)-1)'/<span class="var type0" id="S83T0U922">fn</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,316" id="srcline316">316</a></span><span class="line"><span class="var type0" id="S99T0U925">iqData</span> = <span class="var type0" id="S95T0U926"><span class="message error" id="M16F1C">rf_h</span></span>;<span class="comment">%.*repmat(exp(-2*pi*j*f0*t_dmod),1,size(rf_h,2) );</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,317" id="srcline317">317</a></span><span class="line"><span class="comment">% figure(5)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,318" id="srcline318">318</a></span><span class="line"><span class="comment">% plot(abs(iqData));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,319" id="srcline319">319</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,320" id="srcline320">320</a></span><span class="line"><span class="comment">%% Detection</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,321" id="srcline321">321</a></span><span class="line"><span class="var type0" id="S100T0U929">env</span> = <span class="var type0" id="S99T0U931"><span class="message error" id="M17F1C">iqData</span></span>.*conj(<span class="var type0" id="S99T0U934">iqData</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,322" id="srcline322">322</a></span><span class="line"><span class="var type0" id="S102T0U937">env_n</span> = <span class="var type0" id="S100T0U939"><span class="message error" id="M18F1C">env</span></span>/max(max(<span class="var type0" id="S100T0U944">env</span>)); <span class="comment">%1e-12;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,323" id="srcline323">323</a></span><span class="line"><span class="var type0" id="S103T0U947">log_env</span> = 10*log10(<span class="var type0" id="S102T0U952"><span class="message error" id="M19F1C">env_n</span></span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,324" id="srcline324">324</a></span><span class="line"><span class="comment">% figure(6)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,325" id="srcline325">325</a></span><span class="line"><span class="comment">% % l1=size(log_env);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,326" id="srcline326">326</a></span><span class="line"><span class="comment">% % l2= [1:1:l1(1)];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,327" id="srcline327">327</a></span><span class="line"><span class="comment">% % l3=(2*l2)/c;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,328" id="srcline328">328</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,329" id="srcline329">329</a></span><span class="line"><span class="comment">% plot(log_env);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,330" id="srcline330">330</a></span><span class="line"><span class="comment">%% Display resulting image</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,331" id="srcline331">331</a></span><span class="line"><span class="comment">% Create axes</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,332" id="srcline332">332</a></span><span class="line"><span class="var type0" id="S104T0U955">timetxrx</span> =(0:size(<span class="var type0" id="S81T0U963"><span class="message error" id="M20F1C">rf_d</span></span>,1)-1)/<span class="var type0" id="S83T0U966">fn</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,333" id="srcline333">333</a></span><span class="line"><span class="comment">% [max_pulse_val, max_pulse_idx] = max(abs(hilbert(conv(excitation,conv(impulse_response,impulse_response)))));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,334" id="srcline334">334</a></span><span class="line"><span class="comment">% timetxrx=timetxrx-max_pulse_idx/fs;     % Correct depth axis for duration of excitation and impulse response</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,335" id="srcline335">335</a></span><span class="line"><span class="var type0" id="S105T0U969">disttxrx</span>=(<span class="var type0" id="S104T0U973"><span class="message error" id="M21F1C">timetxrx</span></span>)*<span class="var type0" id="S6T0U974">c</span>/2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,336" id="srcline336">336</a></span><span class="line"><span class="var type0" id="S106T0U978">x_axis_angle</span> = linspace((-<span class="var type1" id="S14T1U984">sector</span>/2),(<span class="var type1" id="S14T1U988">sector</span>/2), size(<span class="var type0" id="S102T0U992"><span class="message error" id="M22F1C">env_n</span></span>, 2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,337" id="srcline337">337</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,338" id="srcline338">338</a></span><span class="line"><span class="comment">% Plot image in beam space</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,339" id="srcline339">339</a></span><span class="line"><span class="autoExtrinsicFcn" id="F501N8:B996">figure</span> (9);</span></span>
<span class="srcline"><span class="lineno"><a href="1,340" id="srcline340">340</a></span><span class="line"><span class="var type0" id="S108T0U1000">h_ph_img</span> = imagesc(<span class="var type0" id="S106T0U1005"><span class="message error" id="M23F1C">x_axis_angle</span></span>*180/pi, <span class="var type0" id="S105T0U1010">disttxrx</span>*1000, <span class="var type0" id="S103T0U1012">log_env</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,341" id="srcline341">341</a></span><span class="line"><span class="autoExtrinsicFcn" id="F502N4:B1015">caxis</span>([-<span class="var type1" id="S79T1U1020">dyn</span> 0]-<span class="var type1" id="S80T1U1022">gain</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,342" id="srcline342">342</a></span><span class="line"><span class="autoExtrinsicFcn" id="F503N13:B1025">xlabel</span>([<span class="string">'Beam angle [deg]'</span>])</span></span>
<span class="srcline"><span class="lineno"><a href="1,343" id="srcline343">343</a></span><span class="line"><span class="autoExtrinsicFcn" id="F504N14:B1031">ylabel</span>(<span class="string">'Range [mm]'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,344" id="srcline344">344</a></span><span class="line"><span class="autoExtrinsicFcn" id="F506N6:B1035">colormap</span>(<span class="autoExtrinsicFcn" id="F505N10:B1037">gray</span>(256));</span></span>
<span class="srcline"><span class="lineno"><a href="1,345" id="srcline345">345</a></span><span class="line">axis <span class="string">on</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,346" id="srcline346">346</a></span><span class="line"><span class="autoExtrinsicFcn" id="F508N8:B1044">figure</span> (11);</span></span>
<span class="srcline"><span class="lineno"><a href="1,347" id="srcline347">347</a></span><span class="line"><span class="var type0" id="S108T0U1048">h_ph_img</span> = imagesc(<span class="var type0" id="S106T0U1053"><span class="message fatal" id="M24F1C">x_axis_angle</span></span>*180/pi, <span class="var type0" id="S105T0U1058">disttxrx</span>*1000, <span class="var type0" id="S103T0U1060">log_env</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,348" id="srcline348">348</a></span><span class="line">caxis([-<span class="var type0" id="S79T0U1068">dyn</span> 0]-<span class="var type0" id="S80T0U1070">gain</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,349" id="srcline349">349</a></span><span class="line">set(gca,<span class="string">'XTick'</span>,-30:10:30)</span></span>
<span class="srcline"><span class="lineno"><a href="1,350" id="srcline350">350</a></span><span class="line">set(gca,<span class="string">'XTickLabel'</span>,-20:6.6:19.6)</span></span>
<span class="srcline"><span class="lineno"><a href="1,351" id="srcline351">351</a></span><span class="line">xlabel([<span class="string">'Lateral distance [mm]'</span>])</span></span>
<span class="srcline"><span class="lineno"><a href="1,352" id="srcline352">352</a></span><span class="line">ylabel(<span class="string">'Axial distance [mm]'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,353" id="srcline353">353</a></span><span class="line">colormap(gray(256));</span></span>
<span class="srcline"><span class="lineno"><a href="1,354" id="srcline354">354</a></span><span class="line">axis <span class="string">on</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,355" id="srcline355">355</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,356" id="srcline356">356</a></span><span class="line"><span class="comment">% Plot scan converted image</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,357" id="srcline357">357</a></span><span class="line"><span class="var type0" id="S114T0U1116">angles_mat</span> = ones(length(<span class="var type0" id="S105T0U1122">disttxrx</span>), 1)*(<span class="var type0" id="S106T0U1126">x_axis_angle</span>+pi/2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,358" id="srcline358">358</a></span><span class="line"><span class="var type0" id="S116T0U1133">ranges_mat</span> = (<span class="var type0" id="S105T0U1137">disttxrx</span>)'*ones(1, length(<span class="var type0" id="S106T0U1143">x_axis_angle</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,359" id="srcline359">359</a></span><span class="line"><span class="var type0" id="S114T0U1145">angles_mat</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,360" id="srcline360">360</a></span><span class="line"><span class="var type0" id="S116T0U1147">ranges_mat</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,361" id="srcline361">361</a></span><span class="line">[<span class="var type0" id="S117T0U1151">X_im</span>, <span class="var type0" id="S118T0U1152">Y_im</span>] = pol2cart(<span class="var type0" id="S114T0U1155">angles_mat</span>, <span class="var type0" id="S116T0U1156">ranges_mat</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,362" id="srcline362">362</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,363" id="srcline363">363</a></span><span class="line">figure (10); </span></span>
<span class="srcline"><span class="lineno"><a href="1,364" id="srcline364">364</a></span><span class="line">pcolor(<span class="var type0" id="S117T0U1165">X_im</span>*1000,<span class="var type0" id="S118T0U1168">Y_im</span>*1000,<span class="var type0" id="S103T0U1170">log_env</span>); </span></span>
<span class="srcline"><span class="lineno"><a href="1,365" id="srcline365">365</a></span><span class="line">caxis([-<span class="var type0" id="S79T0U1178">dyn</span> 0]-<span class="var type0" id="S80T0U1180">gain</span>);       <span class="comment">% Set dynamic range and gain in image</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,366" id="srcline366">366</a></span><span class="line">shading <span class="string">interp</span>; colormap(gray(256));</span></span>
<span class="srcline"><span class="lineno"><a href="1,367" id="srcline367">367</a></span><span class="line">axis <span class="string">ij</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,368" id="srcline368">368</a></span><span class="line">axis <span class="string">equal</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,369" id="srcline369">369</a></span><span class="line">xlabel(<span class="string">'Width [mm]'</span>);ylabel(<span class="string">'Depth [mm]'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,370" id="srcline370">370</a></span><span class="line"><span class="keyword">return</span></span></span>
</pre>
</body>
</html>
